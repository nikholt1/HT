<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${currentPath == '' ? 'Refract Browser - Home' : currentPath + ' Movies | Refract Browser'}"></title>
    <meta name="description"
          th:content="${currentPath == '' ? 'Browse and stream your videos with Refract Browser.' :
                     'Watch ' + currentPath + ' movies and videos online with Refract Browser.'}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/main.css}">
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" th:href="@{https://raw.githubusercontent.com/nikholt1/HTasset/refs/heads/main/storedAssets/R.png}">

</head>
<body>


<section class="HeroSection"
         th:data-video-path="${previewVideoPath}"
         onclick="playPreviewVideo(this)">

    <nav class="navbar">
        <div class="nav-left">
            <a class="navItem" th:href="@{/videos/settings}">Settings</a>

            <form id="search-form" class="search-form" onsubmit="return false;">
                <input type="text" id="search-input" placeholder="Search..." autocomplete="off">
            </form>
        </div>

        <div class="nav-right">
            <a th:href="@{/videos/settings#help}">
                <button class="help-btn" id="helpBtn">Help</button>
            </a>


            <div class="profile-dropdown">
                <img th:src="@{${'/profileImages/' + currentUser.profilePicturePath}}"
                     alt="Profile Picture"
                     class="profile-pic" id="profilePic">
            </div>
        </div>
    </nav>

    <!-- Dropdown placed outside nav -->
    <div class="dropdown-menu" id="dropdownMenu">
        <a class="dpdItem" th:href="@{/}">Change Profile</a>
        <a class="dpdItem" th:href="@{/profiles/manageAccount}">Manage users</a>
        <a class="dpdItem" th:href="@{/profiles/add}">Add new user</a>
        <a class="dpdItem" th:href="@{/videos/settings}">Settings</a>
        <a class="dpdItemLogOut" th:href="@{/logout}">Logout</a>
    </div>


    <!-- Full-screen overlay for results -->
    <div id="search-overlay" class="search-overlay" style="display: none;">
        <div id="search-results" class="search-results"></div>
    </div>

    <!-- Video background -->
    <div th:if="${previewVideoPath != null}" class="hero-video-wrapper">
        <video class="hero-video" autoplay muted loop playsinline>
            <source th:src="@{/videos/stream(filePath=${previewVideoPath})}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="gradient-overlay"></div>
    </div>

    <!-- Image fallback -->
    <div th:if="${previewVideoPath == null}" class="hero-image-wrapper">
        <img class="hero-image" th:src="@{https://raw.githubusercontent.com/nikholt1/HTasset/refs/heads/main/storedAssets/sandDunes.png}" alt="Hero Image">
        <div class="gradient-overlay"></div>
    </div>


    <div class="hero-left-content" th:if="${previewVideoPath == null}">
        <img class="hero-logo" src="https://raw.githubusercontent.com/nikholt1/HTasset/refs/heads/main/loginImage/logo.png" alt="Refract Logo">
        <p class="hero-description">
            Welcome to Refract, here you can stream any of your videos on any device on the same Wi-Fi. <br><br>
            We are currently working on utilizing OpenVPN, to allow you to stream from your home computer, to designated devices anywhere in the world.
        </p>
    </div>


    <!-- Foreground video content -->
    <div class="hero-video-content" th:if="${previewVideoPath != null}">
        <h2 class="hero-title" th:text="${previewVideoName != null ? previewVideoName : currentPath + ' Movies'}"></h2>
        <p class="hero-subtitle">Watch now</p>
    </div>


</section>






<section class="collectionSection">
    <div class="collection">
        <button class="scroll-btn left" onclick="scrollCollection(this, 'left')">&#10094;</button>

        <!-- Folders -->
        <p class="collection-header">Categories</p>
        <ul class="grid">
            <li th:each="item : ${items}" th:if="${item.endsWith('/')}"
                th:with="itemPath=${currentPath != '' ? currentPath + '/' + #strings.substring(item,0,item.length()-1) : #strings.substring(item,0,item.length()-1)}">
                <a th:href="@{/videos/browser(path=${itemPath})}">
                    <div class="image-container">
                        <img th:src="@{/videos/images/{category}/{category}.png(category=${#strings.substringBefore(item, '/')})}"
                             onerror="this.onerror=null; this.src='/videos/images/default.png';"
                             th:alt="${#strings.substringBefore(item, '/')} + ' Image'">
                        <span class="image-label" th:text="${item}"></span>
                    </div>
                </a>
            </li>
        </ul>

        <!-- Videos -->
        <p class="collection-header">Videos</p>
        <ul class="grid">
            <li th:each="item : ${items}" th:if="${!item.endsWith('/') and #strings.trim(item).endsWith('.mp4')}">
                <span th:with="itemPath=${currentPath != '' ? currentPath + '/' + #strings.substring(item,0,item.length()) : item}">
                    <a th:href="@{/videos/stream(filePath=${itemPath})}">
                        <div class="image-container">
                            <img th:src="${'/videos/images/' + itemPath.replace('\\','/').substring(0, itemPath.lastIndexOf('.') != -1 ? itemPath.lastIndexOf('.') : itemPath.length()) + '.png'}"
                                 onerror="this.parentNode.style.display='none';"
                                 th:alt="${item.contains('.') ? item.substring(0, item.lastIndexOf('.')) : item} + ' Image'">
                            <span class="image-label" th:text="${item}"></span>
                        </div>
                    </a>
                    <button type="button" class="cast-button" th:data-url="@{/videos/stream(filePath=${itemPath})}">
                        <span class="material-icons">cast</span>
                    </button>
                </span>
            </li>
        </ul>

    </div>
    <button class="scroll-btn right" onclick="scrollCollection(this, 'right')">&#10095;</button>
</section>



<script>

    const searchInput = document.getElementById('search-input');
    const searchOverlay = document.getElementById('search-overlay');
    const searchResults = document.getElementById('search-results');

    let debounceTimeout;

    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(performSearch, 200); // debounce for typing
    });

    searchInput.addEventListener('focus', () => {
        searchOverlay.style.display = 'block';
    });

    searchInput.addEventListener('blur', () => {
        setTimeout(() => searchOverlay.style.display = 'none', 200); // hide after click
    });

    function performSearch() {
        const query = searchInput.value.trim();
        if (!query) {
            searchResults.innerHTML = '';
            return;
        }

        fetch(`/videos/search?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(results => {
                searchResults.innerHTML = '';

                results.forEach(item => {
                    const link = document.createElement('a');
                    link.textContent = item.name;
                    link.classList.add('search-item');

                    if(item.type === 'folder') {
                        link.href = `/videos/browser?path=${encodeURIComponent(item.path)}`;
                    } else if(item.type === 'video') {
                        link.href = `/videos/stream?filePath=${encodeURIComponent(item.path)}`;
                    }

                    searchResults.appendChild(link);
                });
            })
            .catch(err => console.error('Search error:', err));
    }

    function playPreviewVideo(section) {
        const videoPath = section.getAttribute('data-video-path');
        if (!videoPath) return;

        // redirect to streaming page (replace with your desired URL)
        window.location.href = `/videos/stream?filePath=${encodeURIComponent(videoPath)}`;
    }
    const heroVideo = document.querySelector('.hero-video-wrapper video');

    if (heroVideo) {
        heroVideo.addEventListener('loadedmetadata', () => {
            heroVideo.currentTime = heroVideo.duration * 0.5;
        });
    }

    window['__onGCastApiAvailable'] = function(isAvailable) {
        if (isAvailable) {
            initializeCastApi();
        }
    };

    function initializeCastApi() {
        cast.framework.CastContext.getInstance().setOptions({
            receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
            autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });

        document.querySelectorAll('.cast-button').forEach(button => {
            button.addEventListener('click', () => {
                const url = button.getAttribute('data-url');
                const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
                if (!castSession) {
                    console.log("No cast session yet. Open the cast selector first.");
                    return;
                }
                const mediaInfo = new chrome.cast.media.MediaInfo(url, 'video/mp4');
                const request = new chrome.cast.media.LoadRequest(mediaInfo);

                castSession.loadMedia(request).then(
                    () => console.log('Casting started!'),
                    (err) => console.error('Cast error', err)
                );
            });
        });
    }

    document.querySelectorAll('.cast-button').forEach(btn => {
        btn.addEventListener('click', () => {
            btn.classList.toggle('active');
        });
    });

    const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

    if (!isMobile) {
        document.querySelectorAll('.cast-button').forEach(btn => btn.remove());
    }


    const isAndroid = /Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);


    if (!isAndroid) {
        document.querySelectorAll('.cast-button').forEach(btn => btn.remove());
    }

    const video = document.getElementById('previewVideo');
    if (video) {
        video.addEventListener('loadedmetadata', () => {
            // Start at 40% of the video duration
            video.currentTime = video.duration * 0.4;
        });
    }
    document.addEventListener("DOMContentLoaded", () => {
        const profilePic = document.getElementById("profilePic");
        const dropdown = document.getElementById("dropdownMenu");

        if (profilePic && dropdown) {
            profilePic.addEventListener("click", (e) => {
                e.stopPropagation();
                dropdown.style.display =
                    dropdown.style.display === "block" ? "none" : "block";
            });

            document.addEventListener("click", () => {
                dropdown.style.display = "none";
            });
        }
    });

    function scrollCollection(btn, direction) {
        const section = btn.closest('.collectionSection');
        const container = section.querySelector('.collection');
        const scrollAmount = 250; // adjust how much it scrolls per click

        if(direction === 'left') {
            container.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        } else {
            container.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
    }

</script>

</body>
</html>
